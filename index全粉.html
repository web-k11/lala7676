<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è½æ­Œå˜›ğŸ¶</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pink: {
              50: "#fdf2f8",
              100: "#fce7f3",
              200: "#fbcfe8",
              300: "#f9a8d4",
              400: "#f472b6",
              500: "#ec4899",
              600: "#db2777",
              700: "#be185d",
              800: "#9d174d",
              900: "#831843",
              950: "#500724",
            },
            rose: {
              50: "#fff1f2",
              100: "#ffe4e6",
              200: "#fecdd3",
              300: "#fda4af",
              400: "#fb7185",
              500: "#f43f5e",
              600: "#e11d48",
              700: "#be123c",
              800: "#9f1239",
              900: "#881337",
              950: "#4c0519",
            },
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      min-height: 100vh;
      font-family: 'Noto Sans TC', sans-serif;
      position: relative;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯æ¼‚æµ®å…ƒç´  */
    .floating-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .floating-item {
      position: absolute;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: float 15s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0) translateX(0);
      }
      25% {
        transform: translateY(-20px) translateX(10px);
      }
      50% {
        transform: translateY(-35px) translateX(-15px);
      }
      75% {
        transform: translateY(-15px) translateX(15px);
      }
    }

    /* æœå°‹æ¡†ç´«å…‰æ•ˆæœ */
    .search-glow {
      position: relative;
    }

    .search-glow::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border-radius: 0.5rem;
      background: linear-gradient(45deg, rgba(249, 168, 212, 0), rgba(249, 168, 212, 0.5), rgba(249, 168, 212, 0));
      z-index: -1;
      animation: searchGlow 2s infinite alternate;
    }

    @keyframes searchGlow {
      0% {
        opacity: 0.3;
        background-position: 0% 50%;
      }
      100% {
        opacity: 0.6;
        background-position: 100% 50%;
      }
    }

    /* æ¨™é¡Œç‰¹æ•ˆ - é‡æ–°è¨­è¨ˆ - ç´«ç°æ¼¸å±¤ */
    .title-effect {
      letter-spacing: 0.15em;
      background: linear-gradient(120deg, #fbcfe8, #f9a8d4, #f472b6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      position: relative;
      display: inline-block;
      text-shadow: 1px 2px 4px rgba(244, 114, 182, 0.15);
      animation: titleShimmer 3s infinite;
      font-weight: 800;
      width: 100%; /* ç¢ºä¿æ¨™é¡Œå¯¬åº¦ç‚º100% */
      text-align: center; /* ç¢ºä¿æ¨™é¡Œæ–‡å­—ç½®ä¸­ */
    }

    @keyframes titleShimmer {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* æ¨™é¡Œå…‰æšˆæ•ˆæœ - æ›´æŸ”å’Œ */
    .title-effect::before {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: radial-gradient(circle at center, rgba(249, 168, 212, 0.15) 0%, rgba(249, 168, 212, 0) 70%);
      z-index: -1;
      border-radius: 50%;
      filter: blur(8px);
    }

    /* ç¢ºä¿å‰¯æ¨™é¡Œç½®ä¸­ */
    .subtitle {
      width: 100%;
      text-align: center;
      display: block;
    }

    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(-2px);
      }
      50% {
        transform: translateY(-6px);
      }
    }

    @keyframes wobble {
      0%, 100% {
        transform: rotate(-3deg);
      }
      50% {
        transform: rotate(3deg);
      }
    }

    .empty-icon {
      font-size: 4rem;
      animation: wobble 2s ease-in-out infinite;
      display: inline-block;
    }

    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .song-card {
      transition: all 0.3s ease;
      transform: translateZ(0);
      will-change: transform, box-shadow;
    }

    .song-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .back-to-top {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.75rem;
      border-radius: 9999px;
      background-color: #ec4899;
      color: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 50;
      transition: all 0.3s ease;
    }

    .back-to-top.hidden {
      opacity: 0;
      transform: translateY(2.5rem);
      pointer-events: none;
    }

    .toast-notification {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      z-index: 100;
    }

    .toast-notification.hidden {
      opacity: 0;
      transform: translateX(-50%) translateY(1rem);
      pointer-events: none;
    }

    .loading-spinner {
      height: 2.5rem;
      width: 2.5rem;
      border-radius: 9999px;
      border: 4px solid #e5e7eb;
      border-top-color: #ec4899;
      animation: spinner 0.6s linear infinite;
    }

    /* æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•æ¨£å¼ */
    .clear-button {
      transition: all 0.3s ease;
    }

    .clear-button.disabled {
      opacity: 0.5;
      background-color: rgba(239, 68, 68, 0.1);
      color: rgba(239, 68, 68, 0.5);
    }
    
    /* æœå°‹æ¡†æ¸…é™¤æŒ‰éˆ• */
    .search-clear-button {
      position: absolute;
      right: 2.5rem;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 50%;
      background-color: rgba(156, 163, 175, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .search-clear-button:hover {
      background-color: rgba(156, 163, 175, 0.4);
    }
    
    .search-clear-button.hidden {
      opacity: 0;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯æ¼‚æµ®å…ƒç´  -->
  <div class="floating-bg" id="floating-bg"></div>

  <div id="app" class="container mx-auto px-4 py-6 sm:py-8">
    <header class="text-center mb-6 sm:mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold mb-1 sm:mb-2 title-effect">æˆ‘çš„æ­Œæ›²åº«</h1>
      <p class="text-gray-600 text-base sm:text-lg subtitle">å¹¹ï¼æˆ‘è¶…å¥½è½å•Šï¼</p>
    </header>

    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8 backdrop-blur-sm bg-opacity-90">
      <!-- Search bar -->
      <div class="mb-4 sm:mb-6">
        <div class="relative search-glow">
          <input
            id="search-input"
            type="text"
            placeholder="æœå°‹æ­Œæ›²ã€æ­Œæ‰‹æˆ–èªè¨€..."
            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500 text-gray-700 text-sm sm:text-base"
          />
          <!-- æ¸…é™¤æŒ‰éˆ• -->
          <button id="search-clear" class="search-clear-button hidden" aria-label="æ¸…é™¤æœå°‹">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <!-- æœå°‹åœ–æ¨™ -->
          <svg class="h-4 w-4 sm:h-5 sm:w-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <!-- Category filters -->
      <div class="mb-4 sm:mb-5">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-700">åˆ†é¡</h3>
        </div>

        <div id="category-filter" class="flex gap-2 sm:gap-2.5 flex-wrap">
          <!-- Category buttons will be inserted here -->
        </div>

        <!-- Active filters -->
        <div id="active-filters" class="flex items-center mt-3">
          <div class="flex-grow px-3 py-2 bg-pink-50 rounded-lg">
            <div id="selected-categories" class="flex flex-wrap gap-1">
              <!-- Selected category tags will be inserted here -->
            </div>
          </div>
          <button
            id="clear-categories"
            class="clear-button ml-2 text-sm text-red-600 hover:text-red-800 font-medium px-3 py-1 bg-red-50 rounded-lg hover:bg-red-100 transition-colors disabled"
          >
            æ¸…é™¤æ‰€æœ‰
          </button>
        </div>
      </div>

      <!-- Language filters -->
      <div class="flex flex-col md:flex-row md:items-center gap-4 mb-4">
        <div id="language-filter" class="flex gap-1.5 sm:gap-2 flex-wrap">
          <!-- Language buttons will be inserted here -->
        </div>
      </div>

      <div class="text-gray-600 mb-3">
        <span id="song-count" class="font-medium">0</span> é¦–æ­Œæ›²
      </div>

      <!-- Loading state -->
      <div id="loading" class="flex justify-center py-10">
        <div class="loading-spinner"></div>
      </div>

      <!-- Error state -->
      <div id="error" class="text-center py-10 hidden">
        <div class="h-16 w-16 mx-auto text-red-400 mb-4">âš ï¸</div>
        <p class="text-gray-600 text-lg">ç„¡æ³•ç²å–æ­Œæ›²æ•¸æ“š</p>
        <p class="text-gray-500 mt-2">è«‹ç¢ºä¿Google Sheetæ ¼å¼æ­£ç¢ºï¼Œä¸¦ä¸”å¯ä»¥å…¬é–‹è¨ªå•</p>
        <button
          id="retry-button"
          class="mt-4 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700"
        >
          é‡è©¦
        </button>
      </div>

      <!-- Empty state -->
      <div id="empty-state" class="text-center py-10 hidden">
        <div class="empty-icon mb-4">ğŸ˜•</div>
        <p class="text-gray-600 text-lg">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„æ­Œæ›²</p>
      </div>

      <!-- Songs grid -->
      <div id="songs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
        <!-- Song cards will be inserted here -->
      </div>
    </div>

    <!-- Back to top button -->
    <button id="back-to-top" class="back-to-top hidden" aria-label="å›åˆ°é ‚éƒ¨">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
      </svg>
    </button>

    <!-- Toast notification -->
    <div id="toast-notification" class="toast-notification hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <span>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šé‡
    let allSongs = [];
    let filteredSongs = [];
    let languages = new Set();
    let categories = new Set();
    let categoryCounts = {};
    let categoryOrder = {};
    let selectedCategories = new Set();
    let currentLanguageFilter = 'all';

    // DOM å…ƒç´ 
    const searchInput = document.getElementById('search-input');
    const searchClear = document.getElementById('search-clear');
    const categoryFilter = document.getElementById('category-filter');
    const activeFilters = document.getElementById('active-filters');
    const selectedCategoriesContainer = document.getElementById('selected-categories');
    const languageFilter = document.getElementById('language-filter');
    const songCount = document.getElementById('song-count');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const retryButton = document.getElementById('retry-button');
    const emptyState = document.getElementById('empty-state');
    const songsGrid = document.getElementById('songs-grid');
    const backToTop = document.getElementById('back-to-top');
    const clearCategoriesButton = document.getElementById('clear-categories');
    const toastNotification = document.getElementById('toast-notification');
    const floatingBg = document.getElementById('floating-bg');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      createFloatingElements();
      fetchSheetData();
      setupEventListeners();
    });

    // å‰µå»ºæ¼‚æµ®å…ƒç´ 
    function createFloatingElements() {
      const numElements = 15;
      
      for (let i = 0; i < numElements; i++) {
        const element = document.createElement('div');
        const size = Math.random() * 20 + 5; // 5px to 25px
        const left = Math.random() * 100; // 0% to 100%
        const top = Math.random() * 100; // 0% to 100%
        const delay = Math.random() * 5; // 0s to 5s
        const duration = Math.random() * 10 + 10; // 10s to 20s
        
        element.className = 'floating-item';
        element.style.width = `${size}px`;
        element.style.height = `${size}px`;
        element.style.left = `${left}%`;
        element.style.top = `${top}%`;
        element.style.animationDelay = `${delay}s`;
        element.style.animationDuration = `${duration}s`;
        element.style.opacity = Math.random() * 0.5 + 0.1; // 0.1 to 0.6
        
        floatingBg.appendChild(element);
      }
    }

    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
      // æœç´¢æ¡†
      searchInput.addEventListener('input', () => {
        filterSongs();
        toggleSearchClearButton();
      });
      
      // æœç´¢æ¡†æ¸…é™¤æŒ‰éˆ•
      searchClear.addEventListener('click', () => {
        searchInput.value = '';
        filterSongs();
        toggleSearchClearButton();
        searchInput.focus();
      });

      // æ¸…é™¤åˆ†é¡æŒ‰éˆ•
      clearCategoriesButton.addEventListener('click', () => {
        if (selectedCategories.size > 0) {
          selectedCategories.clear();
          updateSelectedCategoriesUI();
          filterSongs();
        }
      });

      // å›åˆ°é ‚éƒ¨æŒ‰éˆ•
      backToTop.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      // ç›£è½æ»¾å‹•äº‹ä»¶
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTop.classList.remove('hidden');
        } else {
          backToTop.classList.add('hidden');
        }
      });

      // é‡è©¦æŒ‰éˆ•
      retryButton.addEventListener('click', fetchSheetData);
    }
    
    // åˆ‡æ›æœç´¢æ¡†æ¸…é™¤æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
    function toggleSearchClearButton() {
      if (searchInput.value.trim() !== '') {
        searchClear.classList.remove('hidden');
      } else {
        searchClear.classList.add('hidden');
      }
    }

    // ç²å–è©¦ç®—è¡¨æ•¸æ“š
    async function fetchSheetData() {
      showLoading();
      hideError();

      try {
        // ä½¿ç”¨æ–°çš„è©¦ç®—è¡¨ID
        const sheetId = '1SbXNYG39xKU8FrfNQJjK_6V5ZKk30LxT3xzg3MAEuy8';
        
        // ä½¿ç”¨Google Sheets API v4ç›´æ¥ç²å–æ•¸æ“š
        // æ³¨æ„ï¼šé€™éœ€è¦è©¦ç®—è¡¨å·²è¨­ç½®ç‚º"ä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹"
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1?key=AIzaSyDFU1PsOmEKCZfnJkCi5-1kVMi6yk5aDtE`;

        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          // å˜—è©¦ä½¿ç”¨å‚™ç”¨æ–¹æ³•
          return await fetchSheetDataAlternative(sheetId);
        }

        const data = await response.json();
        
        if (!data.values || data.values.length <= 1) {
          throw new Error('No data found in spreadsheet');
        }
        
        // è™•ç†æ•¸æ“š - å°‡æ¨™é¡Œè¡Œèˆ‡æ•¸æ“šè¡Œçµåˆæˆå°è±¡æ•¸çµ„
        const headers = data.values[0];
        const rows = data.values.slice(1);
        
        const processedData = rows.map(row => {
          const item = {};
          headers.forEach((header, index) => {
            item[header] = row[index] || '';
          });
          return item;
        });
        
        processSheetData(processedData);
        hideLoading();
      } catch (err) {
        console.error('Error fetching sheet data:', err);
        // å˜—è©¦ä½¿ç”¨å‚™ç”¨æ–¹æ³•
        await fetchSheetDataAlternative(sheetId);
      }
    }
    
    // å‚™ç”¨ç²å–è©¦ç®—è¡¨æ•¸æ“šæ–¹æ³•
    async function fetchSheetDataAlternative(sheetId) {
      try {
        // ä½¿ç”¨ OpenSheet API ä½œç‚ºå‚™ç”¨
        const apiUrl = `https://opensheet.elk.sh/${sheetId}/Sheet1`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        processSheetData(data);
        hideLoading();
      } catch (err) {
        console.error('Error fetching sheet data (alternative):', err);
        
        // æœ€å¾Œå˜—è©¦ä½¿ç”¨ sheetdb.io
        try {
          const apiUrl = `https://sheetdb.io/api/v1/58f61be4dda40/${sheetId}`;
          const response = await fetch(apiUrl);
          
          if (!response.ok) {
            throw new Error('All methods failed');
          }
          
          const data = await response.json();
          processSheetData(data);
          hideLoading();
        } catch (finalErr) {
          console.error('All methods failed:', finalErr);
          hideLoading();
          showError();
        }
      }
    }

    // è™•ç†è©¦ç®—è¡¨æ•¸æ“š
    function processSheetData(data) {
      // é‡ç½®æ•¸æ“š
      allSongs = [];
      languages = new Set();
      categories = new Set();
      categoryCounts = {};
      categoryOrder = {};
      selectedCategories.clear();

      // é¦–å…ˆè™•ç† F æ¬„çš„ã€Œåˆ†é¡é …ç›®ã€ä¾†ç²å–åˆ†é¡é †åº
      data.forEach((row) => {
        const categoryItem = row.åˆ†é¡é …ç›® || row['åˆ†é¡é …ç›®'] || row.CategoryItem || '';
        if (categoryItem && categoryOrder[categoryItem] === undefined) {
          categoryOrder[categoryItem] = Object.keys(categoryOrder).length;
          categories.add(categoryItem);
        }
      });

      // è™•ç†æ­Œæ›²æ•¸æ“š
      allSongs = data.map((row, index) => {
        const song = {
          id: index + 1,
          title: row.æ­Œå || row.title || row.Song || '',
          artist: row.æ­Œæ‰‹ || row.artist || row.Artist || '',
          language: row.èªè¨€ || row.language || row.Language || '',
          category: row.åˆ†é¡ || row.category || row.Category || '',
          notes: row.å‚™è¨» || row.notes || row.Notes || '',
          categories: []
        };

        if (song.language) {
          languages.add(song.language);
        }

        if (song.category) {
          const categoryList = song.category.split(',').map(cat => cat.trim());
          song.categories = categoryList;

          categoryList.forEach(cat => {
            if (cat) {
              categories.add(cat);
              categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;

              // å¦‚æœé€™å€‹åˆ†é¡é‚„æ²’æœ‰é †åºï¼ˆä¸åœ¨ F æ¬„ä¸­ï¼‰ï¼Œçµ¦å®ƒä¸€å€‹è¼ƒå¤§çš„é †åºå€¼
              if (categoryOrder[cat] === undefined) {
                categoryOrder[cat] = 1000 + Object.keys(categoryOrder).length;
              }
            }
          });
        }

        return song;
      });

      filteredSongs = [...allSongs];
      updateUI();
    }

    // éæ¿¾æ­Œæ›²
    function filterSongs() {
      const searchTerm = searchInput.value.toLowerCase();
      
      filteredSongs = allSongs.filter(song => {
        // èªè¨€éæ¿¾
        if (currentLanguageFilter !== 'all' && song.language !== currentLanguageFilter) {
          return false;
        }

        // åˆ†é¡éæ¿¾
        if (selectedCategories.size > 0) {
          for (const category of selectedCategories) {
            if (!song.categories.includes(category)) {
              return false;
            }
          }
        }

        // æœç´¢éæ¿¾
        if (searchTerm) {
          return (
            (song.title && song.title.toLowerCase().includes(searchTerm)) ||
            (song.artist && song.artist.toLowerCase().includes(searchTerm)) ||
            (song.language && song.language.toLowerCase().includes(searchTerm)) ||
            (song.category && song.category.toLowerCase().includes(searchTerm)) ||
            (song.notes && song.notes.toLowerCase().includes(searchTerm))
          );
        }

        return true;
      });

      updateCategoryCounts();
      updateSongsUI();
    }

    // æ›´æ–°åˆ†é¡è¨ˆæ•¸
    function updateCategoryCounts() {
      const newCounts = {};

      filteredSongs.forEach(song => {
        if (song.categories && song.categories.length > 0) {
          song.categories.forEach(cat => {
            if (cat) {
              newCounts[cat] = (newCounts[cat] || 0) + 1;
            }
          });
        }
      });

      categoryCounts = newCounts;
      updateCategoryFilterUI();
    }

    // æ›´æ–° UI
    function updateUI() {
      updateLanguageFilterUI();
      updateCategoryFilterUI();
      updateSongsUI();
      updateSelectedCategoriesUI();
      updateClearButtonState();
      toggleSearchClearButton();
    }

    // æ›´æ–°æ¸…é™¤æŒ‰éˆ•ç‹€æ…‹
    function updateClearButtonState() {
      if (selectedCategories.size > 0) {
        clearCategoriesButton.classList.remove('disabled');
      } else {
        clearCategoriesButton.classList.add('disabled');
      }
    }

    // æ›´æ–°èªè¨€éæ¿¾å™¨ UI
    function updateLanguageFilterUI() {
      languageFilter.innerHTML = '';

      // ä¸æ·»åŠ "å…¨éƒ¨"æŒ‰éˆ•ï¼Œç›´æ¥æ·»åŠ èªè¨€æŒ‰éˆ•
      Array.from(languages).sort().forEach(language => {
        const button = document.createElement('button');
        button.className = `px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium text-xs sm:text-sm transition-colors ${
          currentLanguageFilter === language ? 'bg-pink-600 text-white hover:bg-pink-700' : ''
        }`;
        button.textContent = language;
        button.addEventListener('click', () => {
          if (currentLanguageFilter === language) {
            // å¦‚æœé»æ“Šç•¶å‰é¸ä¸­çš„èªè¨€ï¼Œå‰‡åˆ‡æ›å›"å…¨éƒ¨"
            currentLanguageFilter = 'all';
          } else {
            currentLanguageFilter = language;
          }
          updateLanguageFilterUI();
          filterSongs();
        });
        languageFilter.appendChild(button);
      });
    }

    // æ›´æ–°åˆ†é¡éæ¿¾å™¨ UI
    function updateCategoryFilterUI() {
      categoryFilter.innerHTML = '';

      // æŒ‰ç…§åŸå§‹é †åºæ’åºåˆ†é¡
      const sortedCategories = Array.from(categories).sort((a, b) => {
        const orderA = categoryOrder[a] !== undefined ? categoryOrder[a] : Number.MAX_SAFE_INTEGER;
        const orderB = categoryOrder[b] !== undefined ? categoryOrder[b] : Number.MAX_SAFE_INTEGER;
        return orderA - orderB;
      });

      sortedCategories.forEach(category => {
        const button = document.createElement('button');
        button.className = `px-3 py-1.5 rounded-lg bg-pink-100 hover:bg-pink-200 text-pink-700 font-medium flex items-center text-base transition-all duration-200 ${
          selectedCategories.has(category)
            ? 'bg-pink-500 text-white hover:bg-pink-600 -translate-y-1 shadow-md'
            : ''
        }`;
        
        const span = document.createElement('span');
        span.className = 'line-clamp-1';
        span.textContent = category;
        button.appendChild(span);

        const count = document.createElement('span');
        count.className = `ml-1.5 inline-flex items-center justify-center min-w-[20px] h-5 px-1 rounded-full text-xs font-semibold ${
          selectedCategories.has(category) ? 'bg-white/30 text-white' : 'bg-pink-200 text-pink-800'
        }`;
        count.textContent = categoryCounts[category] || 0;
        button.appendChild(count);

        button.addEventListener('click', () => {
          toggleCategory(category);
        });

        categoryFilter.appendChild(button);
      });
    }

    // æ›´æ–°å·²é¸æ“‡çš„åˆ†é¡ UI
    function updateSelectedCategoriesUI() {
      selectedCategoriesContainer.innerHTML = '';

      if (selectedCategories.size > 0) {
        Array.from(selectedCategories).forEach(category => {
          const tag = document.createElement('div');
          tag.className = 'filter-tag bg-pink-200 text-pink-800 cursor-pointer text-xs px-2 py-1 rounded-full flex items-center mr-2 mb-1';
          
          const span = document.createElement('span');
          span.textContent = category;
          tag.appendChild(span);

          const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          icon.setAttribute('class', 'h-3 w-3 ml-1');
          icon.setAttribute('fill', 'none');
          icon.setAttribute('viewBox', '0 0 24 24');
          icon.setAttribute('stroke', 'currentColor');
          
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('stroke-linecap', 'round');
          path.setAttribute('stroke-linejoin', 'round');
          path.setAttribute('stroke-width', '2');
          path.setAttribute('d', 'M6 18L18 6M6 6l12 12');
          
          icon.appendChild(path);
          tag.appendChild(icon);

          tag.addEventListener('click', () => {
            toggleCategory(category);
          });

          selectedCategoriesContainer.appendChild(tag);
        });
      } else {
        const emptyText = document.createElement('span');
        emptyText.className = 'text-gray-400 text-xs';
        emptyText.textContent = 'å°šæœªé¸æ“‡ä»»ä½•åˆ†é¡';
        selectedCategoriesContainer.appendChild(emptyText);
      }
      
      updateClearButtonState();
    }

    // æ›´æ–°æ­Œæ›² UI
    function updateSongsUI() {
      songCount.textContent = filteredSongs.length;
      songsGrid.innerHTML = '';

      if (filteredSongs.length === 0) {
        emptyState.classList.remove('hidden');
        songsGrid.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        songsGrid.classList.remove('hidden');

        filteredSongs.forEach(song => {
          const card = createSongCard(song);
          songsGrid.appendChild(card);
        });
      }
    }

    // å‰µå»ºæ­Œæ›²å¡ç‰‡
    function createSongCard(song) {
      const card = document.createElement('div');
      card.className = `song-card bg-white rounded-lg shadow p-2.5 border-l-4 ${getLanguageColor(song.language)} hover:border-pink-500 relative transition-all duration-300 hover:-translate-y-1 hover:shadow-md`;

      // æ¨™é¡Œ
      const title = document.createElement('h3');
      title.className = 'text-lg font-bold text-gray-800 pr-8 line-clamp-1';
      title.textContent = song.title || '';
      card.appendChild(title);

      // æ­Œæ‰‹å’Œèªè¨€
      const artistLangContainer = document.createElement('div');
      artistLangContainer.className = 'flex flex-wrap justify-between items-center mt-1 gap-1';

      const artist = document.createElement('p');
      artist.className = 'text-xs sm:text-sm text-gray-600 line-clamp-1 mr-1';
      artist.textContent = song.artist || '';
      artistLangContainer.appendChild(artist);

      if (song.language) {
        const language = document.createElement('span');
        language.className = `language-tag px-1.5 py-0.5 text-xs rounded-full ${getLanguageClass(song.language)} whitespace-nowrap`;
        language.textContent = song.language;
        artistLangContainer.appendChild(language);
      }

      card.appendChild(artistLangContainer);

      // åˆ†é¡æ¨™ç±¤
      if (song.categories && song.categories.length > 0) {
        const categoriesContainer = document.createElement('div');
        categoriesContainer.className = 'mt-1 flex flex-wrap';

        song.categories.forEach(category => {
          if (category) {
            const tag = document.createElement('span');
            tag.className = `inline-block px-1 py-0.5 text-xs rounded-full mr-1 mb-0.5 cursor-pointer ${
              selectedCategories.has(category)
                ? 'bg-pink-200 text-pink-800 font-medium'
                : 'bg-pink-100 text-pink-800'
            }`;
            tag.textContent = category;
            tag.addEventListener('click', () => {
              toggleCategory(category);
            });
            categoriesContainer.appendChild(tag);
          }
        });

        card.appendChild(categoriesContainer);
      }

      // å‚™è¨»
      if (song.notes) {
        const notes = document.createElement('p');
        notes.className = 'mt-1 text-xs text-gray-500 line-clamp-2';
        
        const noteLabel = document.createElement('span');
        noteLabel.className = 'font-medium';
        noteLabel.textContent = 'å‚™è¨»: ';
        notes.appendChild(noteLabel);
        
        notes.appendChild(document.createTextNode(song.notes));
        card.appendChild(notes);
      }

      // è¤‡è£½æŒ‰éˆ•
      const copyButtonContainer = document.createElement('div');
      copyButtonContainer.className = 'absolute top-5 right-3';

      const copyButton = document.createElement('button');
      copyButton.className = 'p-2 bg-pink-100 hover:bg-pink-200 text-pink-700 rounded-full focus:outline-none shadow-md transition-all duration-200 hover:-translate-y-1 active:scale-95';
      copyButton.setAttribute('aria-label', 'è¤‡è£½æ­Œæ›²è³‡è¨Š');

      const copyIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      copyIcon.setAttribute('class', 'h-9 w-9');
      copyIcon.setAttribute('fill', 'none');
      copyIcon.setAttribute('viewBox', '0 0 24 24');
      copyIcon.setAttribute('stroke', 'currentColor');
      
      const copyPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      copyPath.setAttribute('stroke-linecap', 'round');
      copyPath.setAttribute('stroke-linejoin', 'round');
      copyPath.setAttribute('stroke-width', '2');
      copyPath.setAttribute('d', 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z');
      
      copyIcon.appendChild(copyPath);
      copyButton.appendChild(copyIcon);

      copyButton.addEventListener('click', () => {
        const textToCopy = `${song.artist} - ${song.title}`.trim();
        copyToClipboard(textToCopy);
      });

      copyButtonContainer.appendChild(copyButton);
      card.appendChild(copyButtonContainer);

      return card;
    }

    // åˆ‡æ›åˆ†é¡é¸æ“‡
    function toggleCategory(category) {
      if (selectedCategories.has(category)) {
        selectedCategories.delete(category);
      } else {
        selectedCategories.add(category);
      }
      
      updateSelectedCategoriesUI();
      updateCategoryFilterUI();
      filterSongs();
    }

    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(() => {
            showToast();
          })
          .catch(err => {
            console.error('Failed to copy: ', err);
          });
      } else {
        // å›é€€æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
          document.execCommand('copy');
          showToast();
        } catch (err) {
          console.error('Fallback: Copy command failed', err);
        }
        
        document.body.removeChild(textArea);
      }
    }

    // é¡¯ç¤ºé€šçŸ¥
    function showToast() {
      toastNotification.classList.remove('hidden');
      setTimeout(() => {
        toastNotification.classList.add('hidden');
      }, 2000);
    }

    // é¡¯ç¤ºåŠ è¼‰ä¸­
    function showLoading() {
      loading.classList.remove('hidden');
      songsGrid.classList.add('hidden');
      emptyState.classList.add('hidden');
      error.classList.add('hidden');
    }

    // éš±è—åŠ è¼‰ä¸­
    function hideLoading() {
      loading.classList.add('hidden');
      songsGrid.classList.remove('hidden');
    }

    // é¡¯ç¤ºéŒ¯èª¤
    function showError() {
      error.classList.remove('hidden');
      songsGrid.classList.add('hidden');
      emptyState.classList.add('hidden');
    }

    // éš±è—éŒ¯èª¤
    function hideError() {
      error.classList.add('hidden');
    }

    // ç²å–èªè¨€é¡è‰²
    function getLanguageColor(language) {
      if (!language) return 'border-gray-500';

      const colors = [
        'border-pink-500',
        'border-rose-500',
        'border-pink-400',
        'border-rose-400',
        'border-pink-600',
        'border-rose-600',
        'border-pink-300',
        'border-rose-300',
        'border-pink-700',
      ];

      let hash = 0;
      for (let i = 0; i < language.length; i++) {
        hash = language.charCodeAt(i) + ((hash << 5) - hash);
      }

      const index = Math.abs(hash) % colors.length;
      return colors[index];
    }

    // ç²å–èªè¨€é¡åˆ¥
    function getLanguageClass(language) {
      if (!language) return 'bg-gray-100 text-gray-800';

      const classes = [
        'bg-pink-100 text-pink-800',
        'bg-rose-100 text-rose-800',
        'bg-pink-200 text-pink-800',
        'bg-rose-200 text-rose-800',
        'bg-pink-100 text-pink-700',
        'bg-rose-100 text-rose-700',
        'bg-pink-200 text-pink-700',
        'bg-rose-200 text-rose-700',
        'bg-pink-100 text-pink-900',
      ];

      let hash = 0;
      for (let i = 0; i < language.length; i++) {
        hash = language.charCodeAt(i) + ((hash << 5) - hash);
      }

      const index = Math.abs(hash) % classes.length;
      return classes[index];
    }
  </script>
</body>
</html>
